import os
import logging
import requests
import django
import psycopg2
from concurrent.futures import ThreadPoolExecutor
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()
from django.db import transaction
from django.core.files import File

# –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π
from apps.authentication.models import UserModel
from apps.restaurant.models import Restaurant
from apps.product.models import Category, Menu
from django.db import connection
from django.utils import timezone

logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ MEDIA_ROOT (—É–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))+"/restaurant_photos"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
OLD_DB = {
    "NAME": "aurora",
    "USER": "aurora",
    "PASSWORD": "admin",
    "HOST": "0.0.0.0",
    "PORT": "5432",
}

conn = psycopg2.connect(
    dbname=OLD_DB["NAME"],
    user=OLD_DB["USER"],
    password=OLD_DB["PASSWORD"],
    host=OLD_DB["HOST"],
    port=OLD_DB["PORT"],
)
cursor = conn.cursor()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
def download_image(url, folder, filename):
    """–°–∫–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–∞–ø–∫—É."""
    prefix = "https://aurora-api.uz/media/"
    full_url = prefix + url
    
    save_path = os.path.join(BASE_DIR, folder, filename)  # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    relative_path = os.path.join(folder, filename)  # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è –º–æ–¥–µ–ª–∏

    # –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    if os.path.exists(save_path):
        logging.info(f"–§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {save_path}")
        return relative_path

    try:
        response = requests.get(full_url, timeout=5)
        response.raise_for_status()  # –í—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ HTTP-–∫–æ–¥ –Ω–µ 200

        os.makedirs(os.path.dirname(save_path), exist_ok=True)

        with open(save_path, "wb") as file:
            file.write(response.content)

        logging.info(f"–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {save_path}")
        return relative_path
    except requests.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {full_url}: {e}")
        return None


@transaction.atomic
def migrate_users():
    cursor.execute("SELECT id, username, email, is_active FROM auth_user;")
    users = cursor.fetchall()
    email_counter = 1
    for user in users:
        user_id, username, email, is_active = user
        print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
        print(f"–ü—Ä–æ—Ü–µ—Å—Å –¥–ª—è: ‚Äî‚Äî> {username}, {email}")
        print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")

        if not email or email.strip() == "":
            safe_username = username.strip() if username else "user"
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
            print("–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–µ–π–ª –µ–º–∞–∏–ª")
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
            email = f"{safe_username}_{email_counter}@mail.ru"
            email_counter += 1

        user_obj, created = UserModel.objects.get_or_create(
            id=user_id,
            username=username,
            is_vendor=True,
            code=123456+email_counter,
            code_expiry=timezone.now(),
            user_registered_at= timezone.now(),
            defaults={
                "email": email,
                "is_active": is_active,
            }
        )
        print(user_obj)
        print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")

        if created:
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
            print(f"User {email} ‚Äî‚Äî> uspex.")
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
        else:
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
            print(f"User {email} ‚Äî‚Äî> uje yest.")
            print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")

    print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
    print("Users - uspex")
    print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")


@transaction.atomic
def migrate_restaurants():
    """–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö —Ñ–æ—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ."""
    cursor.execute("SELECT id, user_id, name, adress, telegram, instagramm, logo, photo FROM menu_app_restaurant;")
    restaurants = cursor.fetchall()

    restaurant_objects = []
    image_downloads = {}

    for rest in restaurants:
        rest_id, user_id, name, address, telegram, instagram, logo, photo = rest

        logging.info(f"üöÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞: {name}")

        admin = UserModel.objects.filter(id=user_id).first()
        safe_name = name.replace(" ", "_").lower()

        # –ü—É—Ç–∏ –¥–ª—è logo –∏ photo
        logo_folder = f"vendors/{safe_name}/logo"
        photo_folder = f"vendors/{safe_name}/backgroud"
        logo_filename = "logo.jpg"
        photo_filename = "background.jpg"

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Å–ª–æ–≤–∞—Ä—å
        image_downloads[rest_id] = {
            "logo": (logo, logo_folder, logo_filename),
            "photo": (photo, photo_folder, photo_filename)
        }

        restaurant_objects.append(
            Restaurant(
                id=rest_id,
                admin=admin, 
                name=name, 
                adress=address, 
                telegram_link=telegram if telegram else "telegram", 
                instagram_link=instagram if instagram else "instagram",
                orders_chat_id=1,
                waiter_chat_id=1,
                stir=1,
                legal_name="abc",
                legal_adress="abc",
                contact_entity="+998911234567",
                contact_support="+998911234567"
            )
        )

    # –ú–∞—Å—Å–æ–≤–æ —Å–æ–∑–¥–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
    Restaurant.objects.bulk_create(restaurant_objects, ignore_conflicts=True)
    logging.info(f"‚úÖ {len(restaurant_objects)} —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É")

    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    with ThreadPoolExecutor(max_workers=5) as executor:
        results = {
            (rest_id, img_type): executor.submit(download_image, *img_data)
            for rest_id, img_dict in image_downloads.items()
            for img_type, img_data in img_dict.items()
        }

    # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –∏ background
    updated_restaurants = []
    for (rest_id, img_type), future in results.items():
        img_path = future.result()
        if img_path:
            restaurant = Restaurant.objects.get(id=rest_id)
            with open(os.path.join(BASE_DIR, img_path), "rb") as f:
                django_file = File(f)
                if img_type == "logo":
                    restaurant.logo.save(os.path.basename(img_path), django_file, save=False)
                elif img_type == "photo":
                    restaurant.backgroud_photo.save(os.path.basename(img_path), django_file, save=False)
            updated_restaurants.append(restaurant)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º bulk_update –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—Ä–∞–∑—É
    if updated_restaurants:
        Restaurant.objects.bulk_update(updated_restaurants, ["logo", "backgroud_photo"])
        logging.info(f"‚úÖ {len(updated_restaurants)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ")




@transaction.atomic
def migrate_categories():
    cursor.execute("SELECT id, restaurant_id, name FROM menu_app_category;")
    categories = cursor.fetchall()
    cat_items = []
    for cat in categories:
        cat_id, restaurant_id, name = cat
        logging.info(f"üöÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—é: {name}")
        restaurant = Restaurant.objects.filter(id=restaurant_id).first()

        cat_items.append(
            Category(
                id=cat_id,
                restaurant=restaurant,
                name=name,
                )
        )
    Category.objects.bulk_create(cat_items, ignore_conflicts=True)
    logging.info(f"–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")


@transaction.atomic
def migrate_menus():
    """–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –º–µ–Ω—é –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö —Ñ–æ—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ."""
    cursor.execute("SELECT id, name, description, price, category_id, restaurant_id, photo FROM menu_app_menu;")
    menus = cursor.fetchall()

    menu_objects = []
    image_downloads = {}

    for menu in menus:
        menu_id, name, description, price, category_id, restaurant_id, photo = menu
        logging.info(f"üöÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—é: {name}")
        restaurant = Restaurant.objects.filter(id=restaurant_id).first()
        category = Category.objects.filter(id=category_id).first()

        if not restaurant or not category:
            logging.warning(f"‚ö† –ü—Ä–æ–ø—É—â–µ–Ω–æ: {name} (–Ω–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)")
            continue

        safe_name = name.replace(" ", "_").lower()
        photo_folder = f"menus/{safe_name}"
        photo_filename = "photo.jpg"

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Å–ª–æ–≤–∞—Ä—å
        image_downloads[menu_id] = (photo, photo_folder, photo_filename)

        menu_objects.append(
            Menu(
                id=menu_id,
                name=name,
                description=description, 
                price=price, 
                category=category,  
                restaurant=restaurant,
            )
        )

    # –ú–∞—Å—Å–æ–≤–æ —Å–æ–∑–¥–∞–µ–º –º–µ–Ω—é
    Menu.objects.bulk_create(menu_objects, ignore_conflicts=True)
    logging.warning(f"‚úÖ {len(menu_objects)} –±–ª—é–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É")
    logging.error(f"‚úÖ {len(menu_objects)} –±–ª—é–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É")

    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–æ—Ç–æ
    with ThreadPoolExecutor(max_workers=5) as executor:
        results = {
            menu_id: executor.submit(download_image, *img_data)
            for menu_id, img_data in image_downloads.items()
        }

    # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –≤ –º–µ–Ω—é
    updated_menus = []
    for menu_id, future in results.items():
        img_path = future.result()
        if img_path:
            menu = Menu.objects.get(id=menu_id)
            with open(os.path.join(BASE_DIR, img_path), "rb") as f:
                django_file = File(f)
                menu.photo.save(os.path.basename(img_path), django_file, save=False)
            updated_menus.append(menu)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º bulk_update –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ —Å—Ä–∞–∑—É
    if updated_menus:
        Menu.objects.bulk_update(updated_menus, ["photo"])
        logging.info(f"‚úÖ {len(updated_menus)} —Ñ–æ—Ç–æ –º–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ")


def reset_sequences():
    print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
    print("–°–±—Ä–æ—Å id –¥–ª—è Django")
    print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
    with connection.cursor() as cursor:
        tables = ["restaurant_restaurant", "product_category", "authentication_usermodel", "product_menu"]
        for table in tables:
            cursor.execute(
                f"SELECT setval(pg_get_serial_sequence('{table}', 'id'), "
                f"COALESCE((SELECT MAX(id) FROM {table}), 1) + 1, false);"
            )


def run_migrations():
    migrate_users()
    migrate_restaurants()
    migrate_categories()
    migrate_menus()
    reset_sequences()
    print("****POLNIY USPEX*****")


if __name__ == "__main__":
    run_migrations()








# @transaction.atomic
# def migrate_restaurants():
#     cursor.execute("SELECT id, user_id, name, adress, telegram, instagramm FROM menu_app_restaurant;")
#     restaurants = cursor.fetchall()

#     for rest in restaurants:
#         rest_id, user_id, name, address, telegram, instagram = rest
#         print(f"‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
#         print(f"–ü—Ä–æ—Ü–µ—Å—Å –¥–ª—è: ‚Äî‚Äî> {name}")
#         print(f"‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
#         admin = UserModel.objects.filter(id=user_id).first()  # –°–≤—è–∑—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

#         Restaurant.objects.create(
#             id=rest_id,
#             admin=admin, 
#             name=name, 
#             adress=address, 
#             telegram_link="telegram", 
#             instagram_link="instagram",
#             backgroud_photo="1.jpg",
#             logo="1.jpg",
#             orders_chat_id=1,
#             waiter_chat_id=1,
#             stir=1,
#             legal_name="abc",
#             legal_adress="abc",
#             contact_entity="+998911234567",
#             contact_support="+998911234567"

#         )

#     print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
#     print("Restaurant uspex")
#     print("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
